name: ApiVeritas Contract Tests (Mock Mode + R2 Controlled Upload - DEMO)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  contract-test:
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_KEY }}
      AWS_DEFAULT_REGION: auto
      R2_BUCKET: ${{ secrets.R2_BUCKET }}
      R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Enable mock server mode in config.json
        run: |
          jq '.enableMockServer = true' src/config/config.json > temp && mv temp src/config/config.json

      - name: Build TypeScript
        run: npm run build

      - name: Install AWS CLI
        run: |
          pip install --upgrade pip
          pip install awscli

      - name: Start Mock Server
        run: npm run start:mock &

      - name: Run ApiVeritas config
        run: npx apiveritas config

      - name: Run ApiVeritas test
        run: npx apiveritas test --tests mock.json

      - name: Find latest payload folder
        id: find_payload
        run: |
          latest_folder=$(ls -td payloads/* | head -n 1)
          echo "Latest folder: $latest_folder"
          echo "folder=$latest_folder" >> $GITHUB_OUTPUT
      
      - name: Upload new payload to R2 (timestamped)
        run: |
          aws s3 cp "${{ steps.find_payload.outputs.folder }}/mock/" "s3://$R2_BUCKET/mock/$(basename ${{ steps.find_payload.outputs.folder }})/" \
            --recursive --endpoint-url $R2_ENDPOINT

      - name: List payload folders in R2
        id: list_folders
        run: |
          folder_list=$(aws s3 ls s3://$R2_BUCKET/mock/ --endpoint-url $R2_ENDPOINT | awk '{print $2}' | sed 's#/##')
          folder_count=$(echo "$folder_list" | wc -l)
          echo "Found $folder_count folders: $folder_list"
          echo "folders=$folder_list" >> $GITHUB_OUTPUT
          echo "count=$folder_count" >> $GITHUB_OUTPUT

      - name: Exit if only one folder
        if: steps.list_folders.outputs.count == '1'
        run: |
          echo "Only one payload available in R2, skipping comparison."
          exit 0

      - name: Download last two payload folders from R2
        run: |
          folders=$(echo "${{ steps.list_folders.outputs.folders }}" | sort | tail -n 2)
          latest=$(echo "$folders" | tail -n 1)
          previous=$(echo "$folders" | head -n 1)
          echo "Latest: $latest"
          echo "Previous: $previous"
          
          mkdir -p payloads/latest payloads/previous
          aws s3 sync s3://$R2_BUCKET/mock/$latest/ payloads/latest/mock/ --endpoint-url $R2_ENDPOINT
          aws s3 sync s3://$R2_BUCKET/mock/$previous/ payloads/previous/mock/ --endpoint-url $R2_ENDPOINT

      - name: Run comparison between latest and previous
        run: |
          npx apiveritas compare --testSuite mock --payloads-path payloads/latest --compare-with payloads/previous
      